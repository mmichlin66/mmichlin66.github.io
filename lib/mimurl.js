!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.mimurl=t():e.mimurl=t()}(this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";function n(e){return/^[a-z0-9_\-]+$/i.test(e)}function s(e){return/^[a-z0-9_\-\.%]+$/i.test(e)}function a(e){return/^[a-z0-9_\-]+$/i.test(e)}let i,o,l,u;function h(){return l>=o}function f(e){if(l===o){let t="Unexpected end of URL pattern";throw e&&(t+=": "+e),new L(t)}}function c(e=1){return l<=o-e?(l+=e,u=i[l],!0):(l=o,!1)}r.r(t),r.d(t,"EUrlPart",(function(){return _})),r.d(t,"FieldFormat",(function(){return j})),r.d(t,"parseURL",(function(){return k})),r.d(t,"parseUrlPattern",(function(){return H})),r.d(t,"match",(function(){return M}));class p{constructor(){this.patternString=i,this.parts=[]}get protocol(){return this.parts[_.Protocol]}get hostname(){return this.parts[_.Hostname]}get port(){return this.parts[_.Port]}get path(){return this.parts[_.Path]}get query(){return this.parts[_.Query]}get hash(){return this.parts[_.Hash]}parse(){for(let e=this.findFirstUrlPart();null!==e&&(e.parse(),this.parts[e.urlPart]=e,!h());e=e.getNextUrlPart());}findFirstUrlPart(){if("/"===u)return o>1&&"/"===i[1]?(c(2),new x):(c(),new b);{let e=i.indexOf("://");if(e>0)return new y;if(e<0)return new x;throw new L("URL pattern cannot start from '://'")}}}class d{constructor(){this.location={start:l,length:0}}finalize(){this.location.length=l-this.location.start,this.tokenSting=i.substr(this.location.start,this.location.length)}}class m extends d{constructor(e,t){super(),this.urlPart=e,this.caseSensitive=t}}class g extends m{constructor(e,t){super(e,t)}parse(){let e=new U;e.parse(this.getSegmentEndCharacters(),!1,this.caseSensitive),this.segment=e,this.finalize()}getSegments(){return[this.segment]}}class w extends m{constructor(e,t){super(e,t),this.segments=[]}parse(){let e=this.getPartEndCharacters();for(;!h();){let t=new U;if(t.parse(this.getSegmentEndCharacters(),!0,this.caseSensitive),this.segments.push(t),e.indexOf(u)>=0)break;c()}this.finalize()}getSegments(){return this.segments}}class y extends g{constructor(){super(_.Protocol,!1)}getSegmentEndCharacters(){return":"}getNextUrlPart(){if(":"===u&&l+2<o&&"/"===i[l+1]&&"/"===i[l+2]){return c(3),f(),new x}throw new L("Invalid characters after protocol part")}}class x extends w{constructor(){super(_.Hostname,!1)}getSegmentEndCharacters(){return".:/?#"}getPartEndCharacters(){return":/?#"}getNextUrlPart(){if(":"===u)return c(),f("Port cannot be empty"),new $;if("/"===u)return c(),h()?null:new b;if("?"===u)return c(),h()?null:new v;if("#"===u)return c(),h()?null:new P;throw new L(`Invalid character '${u}' after hostname segment`)}}class $ extends g{constructor(){super(_.Port,!1)}getSegmentEndCharacters(){return"/?#"}getNextUrlPart(){if("/"===u)return c(),h()?null:new b;if("?"===u)return c(),h()?null:new v;if("#"===u)return c(),h()?null:new P;throw new L(`Invalid character '${u}' after port part`)}}class b extends w{constructor(){super(_.Path,!0)}getSegmentEndCharacters(){return"/?#"}getPartEndCharacters(){return"?#"}getNextUrlPart(){if("?"===u)return c(),h()?null:new v;if("#"===u)return c(),h()?null:new P;throw new L(`Invalid character '${u}' after path segment`)}}class v extends m{constructor(){super(_.Query,!0),this.parsedQSPs={},this.allowExtraQueryParams=!0}parse(){for(;!h()&&"#"!==u;)if("!"===u)this.allowExtraQueryParams=!1,c();else{let e=new E;if(e.parse(),e.name in this.parsedQSPs)throw new L(`Query string parameter '${e.name}' appears more than once`);this.parsedQSPs[e.name]=e,"&"===u&&c()}this.finalize()}getNextUrlPart(){if("#"===u)return c(),h()?null:new P;throw new L(`Invalid character '${u}' after query string segment`)}getSegments(){let e=[];for(let t in this.parsedQSPs)e.push(this.parsedQSPs[t].segment);return e}}class P extends g{constructor(){super(_.Hash,!0)}getSegmentEndCharacters(){return""}getNextUrlPart(){return null}}class E extends d{constructor(){super(),this.name=""}parse(){for(;!h()&&"=&#".indexOf(u)<0;)this.name+=u,c();if(!this.name)throw new L("Query string parameter doesn't have name");if(e=this.name,!/^[a-z0-9_\-]+$/i.test(e))throw new L(`Query string parameter name '${this.name}' contains invalid character`);var e;if(h()||"="!==u)throw new L(`Query string parameter '${this.name}' must be followed by '='`);c(),f(`Query string parameter '${this.name}' doesn't have value`);let t=new U;t.parse("&#",!0,!0),this.segment=t,this.finalize()}isNameEndCharacter(e){return"=&#".indexOf(e)>=0}}class U extends d{constructor(){super(),this.isOptional=!1,this.isMulti=!1,this.fields=[]}parse(e,t,r){this.analizeFirstChar(e,t)&&c();let n=[];for(;!h()&&e.indexOf(u)<0;){let t;if("{"===u){let r=new O;r.parse(e),t=r}else if("("===u){let e=new R;e.parse(),t=e}else{let r=new S;r.parse(e+"{("),t=r}n.push(t)}this.generateRegExp(n,r),this.finalize()}analizeFirstChar(e,t){switch(u){case"?":return this.isOptional=!0,!0;case"!":return!0;case"*":if(!t)throw new L("Single-value segment URL part cannot start from '*'");return this.isOptional=this.isMulti=!0,!0;case"+":if(!t)throw new L("Single-segment URL part cannot start from '+'");return this.isMulti=!0,!0;default:if(e.indexOf(u)>=0)throw new L("Empty segment encountered");return!1}}generateRegExp(e,t){let r=1,n="";if(0===e.length)n+=".+";else for(let t of e)t instanceof S?n+=t.content:t instanceof R?(n+="("+t.content+")",r+=1+t.capturingGroupQty):(t.isArray=this.isMulti,t.index=r,this.fields.push(t),n+=this.generateRegExpSectionForField(t),r++,t.matchPattern&&(r+=1+t.matchPattern.capturingGroupQty));this.regExp=new RegExp(n,t?"":"i")}generateRegExpSectionForField(e){let t="";return e.matchPattern&&e.matchPattern.content?(t+=e.matchPattern.content,e.isOptional&&(t+="?")):e.isOptional?t+="(.*)":t+="(.+)",t}}class S extends d{constructor(){super(),this.content=""}parse(e){let t="";for(;!h()&&e.indexOf(u)<0;)t+=u,c();if(!function(e){return/^[a-z0-9_\-\.%]+$/i.test(e)}(t))throw new L(`Text token '${t}' contains invalid characters`);try{this.content=decodeURIComponent(t)}catch(e){throw new L(`Text token '${t}' cannot be URL-decoded. Error: ${e.message}`)}this.finalize()}}class R extends d{constructor(){super(),this.content="",this.capturingGroupQty=0}parse(){let e=[];for(;!h();){let t=u;if(")"===t){if("("!==e.pop())throw new L(`Non-matching character '${t}' in regular expression`);if(c(),0===e.length)return this.content+=t,void this.finalize()}else if("}"===t){if("{"!==e.pop())throw new L(`Non-matching character '${t}' in regular expression`);c()}else if("]"===t){if("["!==e.pop())throw new L(`Non-matching character '${t}' in regular expression`);c()}else"({[".indexOf(t)>=0?("("===t&&this.capturingGroupQty++,e.push(t),c()):"\\"===t?(this.content+=t,c(),f(`In the Regexp '${this.content}', the escape character '\\' must be followed by another character`),t=u,c()):c();this.content+=t}throw new L("Invalid URL pattern end within regular expression")}finalize(){if(!this.content)throw new L("Empty regular expression");super.finalize()}}class O extends d{constructor(){super(),this.isOptional=!1,this.name="",this.format=j.String,this.matchPattern=null}parse(e){for(c(),f("A field must define a name"),"?"===u&&(this.isOptional=!0,c());!h();){if(e.indexOf(u)>=0)throw new L("Field doesn't have closing '}'");if("}(%=".indexOf(u)>=0)break;this.name+=u,c()}if(0===this.name.length)throw new L("Field must have name");if(t=this.name,!/^[a-z_][a-z0-9_]*$/i.test(t))throw new L(`Field name '${this.name}' contains invalid characters`);var t;if(f(`Field '${this.name}' doesn't have closing '}'`),"%"===u){c(),f(`Field '${this.name}' doesn't specify format after '%'`);let e=u;if("i"===e)this.format=j.Integer,c();else if("f"===e)this.format=j.Float,c();else{if("b"!==e)throw new L(`Field '${this.name}' has invalid format character '${u}'`);this.format=j.Boolean,c()}f(`Field '${this.name}' doesn't have closing '}'`)}if("("===u){let e=new R;e.parse(),this.matchPattern=e,f(`Field '${this.name}' doesn't have closing '}'`)}if("="===u)this.isOptional=!0,c(),this.parseDefaultValue(e);else switch(this.format){case j.Integer:case j.Float:this.defaultValue=NaN;break;case j.Boolean:this.defaultValue=void 0;break;default:this.defaultValue=""}if("}"!==u)throw new L(`Field '${this.name}' has invalid character '${u}'`);this.finalize(),c()}parseDefaultValue(e){let t="";for(;!h();){if(e.indexOf(u)>=0)throw new L(`Field '${this.name}' doesn't have closing '}'`);if("}"===u)break;t+=u,c()}if(!t)throw new L(`Field '${this.name}' default value cannot be empty`);if(t=decodeURIComponent(t),this.format===j.Integer){if(this.defaultValue=Number(t),isNaN(this.defaultValue)||!Number.isInteger(this.defaultValue))throw new L(`Default value '${t}' of Integer field '${this.name}' cannot be converted to Integer`)}else if(this.format===j.Float){if(this.defaultValue=Number(t),isNaN(this.defaultValue))throw new L(`Default value of '${t}' Float field '${this.name}' cannot be converted to Float`)}else if(this.format===j.Boolean){let e=t.toLowerCase();if("true"===e||"t"===e||"yes"===e||"y"===e||"1"===e)this.defaultValue=!0;else{if("false"!==e&&"f"!==e&&"no"!==e&&"n"!==e&&"0"!==e)throw new L(`Default value of '${t}' Boolean field '${this.name}' cannot be converted to Boolean`);this.defaultValue=!1}}else this.defaultValue=t}}class L extends Error{constructor(e){super(),this.pos=l,this.message=`Error at position ${this.pos}: ${e}`}}function F(e,t){if(!e)throw new Error("URL cannot be null");if(!t)throw new Error("parsedPattern cannot be null");let r=new q;r.parsedURL=e,r.fields={};let n=[];try{let s=N(_.Protocol,e.protocol,t.protocol?t.protocol.segment:null,r.fields);s&&n.push(s),s=I(_.Hostname,e.hostname,t.hostname?t.hostname.segments:null,r.fields),s&&n.push(s),s=N(_.Port,e.port,t.port?t.port.segment:null,r.fields),s&&n.push(s),s=I(_.Path,e.path,t.path?t.path.segments:null,r.fields),s&&n.push(s),s=function(e,t,r){if(!t)return null;if(!e)return 0===Object.keys(t.parsedQSPs).length?null:"URL doesn't have query string parameters specified in the pattern";for(let r in t.parsedQSPs)if(void 0===e[r])return`URL doesn't have query string parameter '${r}'`;for(let n in e){let s=t.parsedQSPs[n].segment;if(s){let t=e[n];if(!s.isMulti&&t.length>1)return`URL has multiple values for query string parameter '${n}' while pattern doesn't specify it as multi`;for(let e of t)if(!Q(e,s,r))return`URL's query string parameter '${n}' doesn't match that specified in the pattern`}else if(!t.allowExtraQueryParams)return`URL has query string parameter '${n}' that is not specified in the pattern`}return null}(e.query,t.query,r.fields),s&&n.push(s),s=N(_.Hash,e.hash,t.hash?t.hash.segment:null,r.fields),s&&n.push(s)}catch(e){n.push(e.message)}return n.length>0&&(r.errors=n),r}function N(e,t,r,n){return"number"==typeof t&&(t=t.toString()),r?t?Q(t,r,n)?null:`URL segment '${t}' in part '${_[e]}' doesn't match pattern segment '${r.tokenSting}'`:r.isOptional?null:`URL part '${_[e]}' doesn't have a segment corresponding to a mandatory pattern segment '${r.tokenSting}'`:t?`URL part '${_[e]}' contains segment '${t}' that doesn't exist in the pattern`:null}function Q(e,t,r){let n=t.regExp.exec(e);if(!n||n[0]!==e)return!1;for(let e of t.fields){if(e.index>=n.length)return console.error("BUG: Field index not found in patter's regular expression execution result"),!1;let t=V(e,n[e.index]);if(e.isArray){let n=r[e.name];void 0===n&&(n=[],r[e.name]=n),n.push(t)}else r[e.name]=t}return!0}function I(e,t,r,n){if(!t&&!r)return null;if(!t)return`URL doesn't have part '${_[e]}' that exists in the pattern`;if(!r)return`URL has part '${_[e]}' that doesn't exist in the pattern`;let s=[];for(let e of r)e.isMulti&&!e.isOptional?(s.push(new C(e,!1)),s.push(new C(e,!0))):s.push(new C(e,e.isOptional));return function e(t,r,n,s,a){let i=r,o=s;for(;o<n.length&&i<t.length;){let r=n[o],s=t[i];if(r.isOptional){let l={};if(e(t,i,n,o+1,l))return z(a,l),!0;if(l={},!Q(s,r.parsedSegment,l))return!1;z(a,l),i++,r.parsedSegment.isMulti||o++}else{if(!Q(s,r.parsedSegment,a))return!1;o++,i++}}if(o===n.length&&i===t.length)return!0;if(o===n.length)return!1;for(let e=o;e<n.length;e++){if(!n[e].isOptional)return!1}return!0}(t,0,s,0,n)?null:`URL part '${_[e]}' doesn't match the pattern`}function z(e,t){for(let r in t){let n=t[r],s=e[r];if(void 0===s)e[r]=n;else{let e=n,t=s;for(let r of e)t.push(r)}}}function V(e,t){if(!t)return e.defaultValue;switch(e.format){case j.Integer:{let r=Number(t);return isNaN(r)||!Number.isInteger(r)?e.defaultValue:r}case j.Float:{let r=Number(t);return isNaN(r)?e.defaultValue:r}case j.Boolean:{let r=t.toLowerCase();return"true"===r||"t"===r||"yes"===r||"y"===r||"1"===r||"false"!==r&&"f"!==r&&"no"!==r&&"n"!==r&&"0"!==r&&e.defaultValue}default:return t}}class C{constructor(e,t){this.parsedSegment=e,this.isOptional=t}}class q{get success(){return!this.errors||0===this.errors.length}}var _,j;function k(e){return function(e){let t,r={},i=e.indexOf("://");if(0===i)throw new Error("URL cannot start from '://'");if(i>0){if(r.protocol=e.substr(0,i),o=r.protocol,!/^[a-z0-9]+$/i.test(o))throw new Error(`Protocol '${r.protocol}' contains invalid characters`);t=i+3}else t="/"===e[0]?-1:0;var o;let l=t<0?0:t,u=e.indexOf(":",l),h=e.indexOf("/",l),f=e.indexOf("?",l),c=e.indexOf("#",l);if(t>=0){r.hostname=u>0?e.substr(t,u-t).split("."):h>0?e.substr(t,h-t).split("."):f>0?e.substr(t,f-t).split("."):c>0?e.substr(t,c-t).split("."):e.substr(t).split(".");for(let e=0;e<r.hostname.length;e++){let t=r.hostname[e];if(!n(t))throw new Error(`Hostname segment '${t}' contains invalid characters`)}}if(u>0){let t;if(t=h>0?e.substr(u+1,h-u-1):f>0?e.substr(u+1,f-u-1):c>0?e.substr(u+1,c-u-1):e.substr(u+1),!function(e){return/^\d+$/i.test(e)}(t))throw new Error(`Port '${t}' contains non-numerical characters`);r.port=Number(t)}if(h>=0){r.path=f>0?e.substr(h+1,f-h-1).split("/"):c>0?e.substr(h+1,c-h-1).split("/"):e.substr(h+1).split("/");for(let e=0;e<r.path.length;e++){let t=r.path[e];if(!s(t))throw new Error(`Path segment '${t}' contains invalid characters`);try{t=decodeURIComponent(t)}catch(e){throw new Error(`Path segment '${t}' cannot be URL-decoded. Error: ${e.message}`)}r.path[e]=t}}if(f>0){let t;r.query={},t=c>0?e.substr(f+1,c-f-1):e.substr(f+1);let n=t.split("&");for(let e of n){if(!e)throw new Error("Invalid stucture of query string URL part");let t,n,i=e.split("=");if(i.length>2)throw new Error(`Query string parameter '${e}' has more than one '=' symbol`);if(i.length<2?(t=e,n=void 0):(t=i[0],n=i[1]),!a(this.name))throw new Error(`Query string parameter name '${t}' contains invalid character`);if(n){if(!s(n))throw new Error(`Value '${n}' of query string parameter '${t}' contains invalid characters`);try{n=decodeURIComponent(n)}catch(e){throw new Error(`Value '${n}' of query string parameter '${t}' cannot be URL-decoded. Error: ${e.message}`)}}t in r.query?r.query[t].push(n):r.query[t]=[n]}}if(c>0){let t=e.substr(c+1);if(!s(t))throw new Error(`Value '${t}' of hash URL part contains invalid characters`);try{r.hash=decodeURIComponent(t)}catch(e){throw new Error(`Value '${t}' of hash URL part cannot be URL-decoded. Error: ${e.message}`)}}return r}(e)}function H(e){return function(e){if(i=e,o=0,l=0,u="",!e)throw new L("URL pattern cannot be empty");o=e.length,u=e[0];let t=new p;return t.parse(),t}(e)}function M(e,t){return function(e,t){if(!e)throw new Error("URL cannot be null or empty string");if(!t)throw new Error("Pattern cannot be null or empty string");return F("string"==typeof e?k(e):e,"string"==typeof t?H(t):t)}(e,t)}!function(e){e[e.Protocol=0]="Protocol",e[e.Hostname=1]="Hostname",e[e.Port=2]="Port",e[e.Path=3]="Path",e[e.Query=4]="Query",e[e.Hash=5]="Hash"}(_||(_={})),function(e){e[e.String=0]="String",e[e.Integer=1]="Integer",e[e.Float=2]="Float",e[e.Boolean=3]="Boolean"}(j||(j={}))}])}));